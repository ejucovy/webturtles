<html><head>
    <script src="../lib/loader.js" type="text/javascript"></script>
  </head><body>

      <table id="grid" style="width: 750px;
			      height: 400px;
			      border: 1px solid black;
			      border-style: collapse;">
        <tr>
	  <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
	  <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
	  <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
	  <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
	  <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
	</tr>
        <tr>
	  <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
	  <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
	  <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
	  <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
	  <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
	</tr>
        <tr>
	  <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
	  <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
	  <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
	  <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
	  <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
	</tr>
        <tr>
	  <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
	  <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
	  <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
	  <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
	  <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
	</tr>
        <tr>
	  <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
	  <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
	  <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
	  <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
	  <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
	</tr>
        <tr>
	  <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
	  <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
	  <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
	  <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
	  <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td><td></td>
	</tr>

      </table>

      <h1>Click to drop some random turtles</h1>

    <script type="text/javascript">
      var world;
 
      var possibleCmds = ["freefwd 100", "clone", "rotate 45"];

      var whenSeedLands = function(seed) {
        var cell = findCellForPos(world.table, seed.attr("cx"), seed.attr("cy"));
        var pos = findCellCoordinates(cell);
        world.addTurtle(pos.col, pos.row, seed.attr("fill"));
        var thatNewTurtle = world.turtles[world.turtles.length-1];
        rotate(thatNewTurtle, 180);
        seed.remove();
        growBranch(thatNewTurtle);
      };

      function growBranch(thatNewTurtle) {
        var trunkLength = Math.floor(Math.random()*100);
        thatNewTurtle.pushQueue("freefwd " + trunkLength);
      };

      function makeClone(turtle) {
        var rotation = Math.floor(Math.random()*160);
        rotation = rotation - 80;
        // rotation can be between (-80,80)
        turtle.pushQueue("rotate " + rotation);
        var initCmd = "freefwd " + Math.floor(Math.random()*100);
        turtle.pushQueue("clone " + initCmd);
        turtle.pushQueue("rotate " + -1*rotation);
      };

      var installCommands = function(thatNewTurtle) {
        var choice = Math.floor(Math.random()*10);
        if( choice > 6 ) {
          thatNewTurtle.pushQueue("destroy");
          return;
        };
        if( choice < 3 ) {
          makeClone(thatNewTurtle);
	};
        growBranch(thatNewTurtle);
      };

      $(window).click(function(e) {
        var pos = {};
        pos.x = e.clientX; pos.y = e.clientY;
        var c = world.paper.circle(pos.x, 0, 10);
        var rand = function() { return Math.floor(Math.random()*255); };
        var rgb = "rgb(" + rand() + "," + rand() + "," + rand() + ")";
        c.attr("fill", rgb);
        c.animate({cy: world.paper.height}, 1000, function() { whenSeedLands(c) });
        console.log(c);
      });

      window.onload = function() {
       step = function(world) {
         world.step();
         for( var i = 0; i < world.turtles.length; ++i ) {
           var turtle = world.turtles[i];
	   if( turtle.dead ) continue;
           if( turtle.getQueue().length == 0 ) {
             installCommands(turtle);
           };
         };
         window.setTimeout(function() { step(world) },
		      750);
       };
       world = new World("table#grid");
       step(world);

      };
      </script>
     </body></html>
